#!/usr/bin/env python

from __future__ import absolute_import, division, print_function, unicode_literals

import os
import sys
import json
import node
from config import App

if len(sys.argv) != 2:
    print("stackful-node-web <config file>")
    sys.exit(255)

config_file = sys.argv[1]
with open(config_file, "r") as cf:
    config = json.load(cf)

web_env = os.environ.copy()
config_env = {}

if "stackful-environment" in config:
    config_env = config["stackful-environment"]

for var, val in config_env.items():
    web_env[var] = str(val)

flushables = [sys.stdout, sys.stderr]
for f in flushables:
    f.flush()

app = App()
available_deployers = [node]
deployers = [deployer for deployer in available_deployers if deployer.detect(app)]
if not deployers:
    print("Cannot start app. Unknown stack type.")
    sys.exit(255)

executable, args = deployers[0].server_command(app)
#replace current process with node, passing the custom environment
os.execvpe(executable, args, web_env)
